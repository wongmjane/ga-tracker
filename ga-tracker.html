<link rel="import" href="../polymer/polymer.html">

<script async src='https://www.google-analytics.com/analytics.js'></script>

<!--
`<ga-tracker>` adds Google Analytics's JavaScript library on your page (with respect of user's choice on [DoNotTrack](https://www.w3.org/TR/tracking-dnt/) unless specified not to).

In typical use, just slap one `<ga-tracker>`:

    <ga-tracker id="UA-XXXXX-Y"></ga-tracker>

For more information, please reference [Google Analytics Developer Guides](https://developers.google.com/analytics/devguides/collection/analyticsjs/field-reference).
-->

<dom-module id="ga-tracker">
  <template>
    <style>
      :host {
        display: none;
        visibility: hidden;
      }
    </style>
  </template>

  <script>
    Polymer({

      is: 'ga-tracker',

      properties: {

        /**
         * The [Tracking ID / Web Property ID](https://developers.google.com/analytics/devguides/collection/analyticsjs/field-reference#trackingId)
         * @type {String}
         */
        id: String,

        /**
         * If false, disrespect user's choice on [DoNotTrack](https://www.w3.org/TR/tracking-dnt/).
         * @type {Boolean}
         */
        respectDNT: {
          type: Boolean,
          value: true
        },

        /**
         * trackerName
         * @type {String}
         */
        name: {
          type: String,
          readOnly: true
        }
      },

      created: function() {
        window.ga = window.ga || function() {
          (ga.q = ga.q || []).push(arguments);
        };
        ga.l = +new Date;
      },

      attached: function() {
        var id = this.getAttribute('id') || undefined;

        if(navigator.doNotTrack && !this.getAttribute('respectDNT')) {
          if(id) {
            window['ga-disable-' + id] = true;
          }
        } else {
          if(id) {
            var _tracker = ga('create', id, 'auto');
            if(_tracker) {
              this.setName(_tracker.get('name'));
              ga('send', 'pageview');
            }
          }
        }
      },

      detached: function() {
        window['ga-disable-' + this.getAttribute('id')] = undefined;
        if(this.getAttribute('name')) {
          ga.remove(this.getAttribute('name'));
        }
      }

    });
  </script>
</dom-module>
